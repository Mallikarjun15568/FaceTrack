// ---------------- FULLSCREEN AUTO-ENABLE ----------------
function enableFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
        elem.requestFullscreen().catch(err => console.log("Fullscreen denied:", err));
    } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
    }
}

// Auto-enable fullscreen after 2 seconds (gives time for user interaction)
setTimeout(() => {
    if (!document.fullscreenElement) {
        enableFullscreen();
    }
}, 2000);

// Re-enable if user exits fullscreen
document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
        setTimeout(enableFullscreen, 3000);
    }
});


// ---------------- SOUND FEEDBACK ----------------
// Simple beep sound generator
function playBeep(frequency = 800, duration = 200) {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
    } catch (e) {
        console.log("Audio playback failed:", e);
    }
}

const sounds = {
    success: () => playBeep(1000, 150),  // High pitch - success
    error: () => playBeep(400, 300),     // Low pitch - error
    unknown: () => playBeep(600, 200)    // Mid pitch - warning
};


// ---------------- CAMERA START ----------------
const video = document.getElementById("video");

async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480, facingMode: "user" }
        });
        video.srcObject = stream;
    } catch (error) {
        console.error("Camera Error:", error);
    }
}
startCamera();


// ---------------- UI ELEMENTS ----------------
const waitingBlock = document.getElementById("waiting-block");
const waitingBlockDefaultContent = waitingBlock.innerHTML;
const employeeCard = document.getElementById("employee-card");
const empPhoto = document.getElementById("emp-photo");
const empName = document.getElementById("emp-name");
const empDept = document.getElementById("emp-dept");
const statusArea = document.getElementById("status-area");
const logsList = document.getElementById("logs-list");


// ---------------- STATUS BADGES ----------------
const BADGE = {
    "check-in":  { text:"CHECK-IN SUCCESS",  cls:"bg-green-500 text-white" },
    "check-out": { text:"CHECK-OUT SUCCESS", cls:"bg-sky-500 text-white" },
    "already":   { text:"ALREADY MARKED",    cls:"bg-yellow-400 text-black" },
    "unknown":   { text:"UNKNOWN FACE",      cls:"bg-red-500 text-white" },
};


// ---------------- HELPER FUNCTIONS ----------------
function getCurrentTime() {
    return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function makeBadge(status) {
    const div = document.createElement("div");
    div.className = `px-6 py-2 rounded-full text-sm font-semibold shadow ${BADGE[status].cls}`;
    div.textContent = BADGE[status].text;
    return div;
}

function addLog(name, status, time, photo) {
    const row = document.createElement("div");
    row.className =
        "flex items-center gap-3 bg-gray-50 border border-gray-200 p-2 rounded-lg";

    const img = document.createElement("img");
    img.src = photo || "/static/default_user.png";
    img.className = "w-10 h-10 rounded-md border object-cover";

    const meta = document.createElement("div");
    const n = document.createElement("p");
    const s = document.createElement("p");

    n.className = "font-semibold text-gray-800";
    s.className = "text-sm text-gray-500";

    n.textContent = name;
    s.textContent = `${BADGE[status].text} ‚Ä¢ ${time}`;

    meta.appendChild(n);
    meta.appendChild(s);

    row.appendChild(img);
    row.appendChild(meta);

    logsList.prepend(row);

    // Keep only last 5 logs
    if (logsList.children.length > 5) {
        logsList.removeChild(logsList.lastChild);
    }
}


// ---------------- UPDATE UI AFTER RECOGNITION ----------------
function updateUI(result) {
    waitingBlock.innerHTML = waitingBlockDefaultContent;
    waitingBlock.classList.add("hidden");
    employeeCard.classList.remove("hidden");

    empName.textContent = result.name || "Unknown";
    empDept.textContent = result.dept || "";
    empPhoto.src = result.photoUrl || "/static/default_user.png";

    statusArea.innerHTML = "";
    statusArea.appendChild(makeBadge(result.status));

    // Play sound feedback
    if (result.status === "check-in" || result.status === "check-out") {
        sounds.success();
    } else if (result.status === "already") {
        sounds.error();
    }

    if (result.status !== "already") {
        addLog(result.name, result.status, result.time, result.photoUrl);
    }
}


function showUnknownAlert(time) {
    waitingBlock.classList.remove("hidden");
    employeeCard.classList.add("hidden");
    waitingBlock.innerHTML = `
        <p class="font-semibold text-gray-900">Unknown face detected</p>
        <p class="text-xs text-gray-500">Please center your face in the frame and hold still.</p>
        <p class="text-xs text-gray-400 mt-1">Last seen at ${time || getCurrentTime()}</p>
    `;
    
    // Play unknown sound
    sounds.unknown();
}


// ---------------- LIVENESS DETECTION ----------------
let livenessCheckActive = true;
let livenessPassed = false;
let currentChallenge = null;

function getChallengeMessage(challenge) {
    const messages = {
        "blink": "üëÅÔ∏è Please blink naturally",
        "head_left": "‚¨ÖÔ∏è Turn your head LEFT",
        "head_right": "‚û°Ô∏è Turn your head RIGHT"
    };
    return messages[challenge] || "Verifying...";
}

function showLivenessChallenge(challenge, progress, message) {
    waitingBlock.classList.remove("hidden");
    employeeCard.classList.add("hidden");
    
    const progressBar = Math.min(100, progress);
    
    waitingBlock.innerHTML = `
        <div class="text-center">
            <p class="text-2xl mb-2">${getChallengeMessage(challenge)}</p>
            <p class="text-sm text-gray-600 mb-3">${message}</p>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${progressBar}%"></div>
            </div>
        </div>
    `;
}

async function checkLiveness(frameData) {
    try {
        const res = await fetch("/kiosk/liveness_check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ frame: frameData })
        });

        if (!res.ok) {
            console.error("Liveness check error:", res.status);
            return false;
        }

        const data = await res.json();
        
        if (!data.success) {
            showLivenessChallenge(data.challenge || "blink", 0, data.message || "Please try again");
            return false;
        }

        if (data.liveness_passed) {
            livenessPassed = true;
            livenessCheckActive = false;
            
            // Show success briefly
            waitingBlock.innerHTML = `
                <div class="text-center">
                    <p class="text-2xl text-green-600">‚úì Verification Complete!</p>
                    <p class="text-sm text-gray-600">Recognizing face...</p>
                </div>
            `;
            sounds.success();
            
            return true;
        } else {
            currentChallenge = data.challenge;
            showLivenessChallenge(data.challenge, data.progress, data.message);
            return false;
        }

    } catch (err) {
        console.error("Liveness check failed:", err);
        return false;
    }
}


// ---------------- POLLING LOOP ----------------
const POLLING_DELAY_MS = 500;  // Faster for liveness detection
let sendingFrame = false;

async function sendFrame() {
    if (sendingFrame) return;
    if (!video.videoWidth || !video.videoHeight) return;

    sendingFrame = true;

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const frameData = canvas.toDataURL("image/jpeg", 0.8);

    try {
        // Step 1: Liveness check
        if (livenessCheckActive) {
            await checkLiveness(frameData);
            return;
        }

        // Step 2: Recognition (only after liveness passed)
        if (!livenessPassed) {
            return;
        }

        const res = await fetch("/kiosk/recognize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ frame: frameData })
        });

        if (!res.ok) {
            console.error("Server error:", res.status);
            return;
        }

        const data = await res.json();
        
        if (data.status === "ignore") {
            return;
        }

        if (data.status === "unknown") {
            showUnknownAlert(data.time);
            // Reset liveness for next attempt
            resetLiveness();
            return;
        }

        updateUI(data);
        
        // Reset liveness for next person
        setTimeout(resetLiveness, 3000);

    } catch (err) {
        console.error("Recognition Error:", err);
    } finally {
        sendingFrame = false;
    }
}

function resetLiveness() {
    livenessCheckActive = true;
    livenessPassed = false;
    currentChallenge = null;
}

async function startRecognitionLoop() {
    await sendFrame();
    setTimeout(startRecognitionLoop, POLLING_DELAY_MS);
}

startRecognitionLoop();
