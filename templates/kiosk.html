{% extends "base_kiosk.html" %}
{% block title %}Kiosk Mode - FaceTrack{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}

<!-- TOP BAR -->
<div class="h-16 px-6 flex items-center justify-between bg-white border-b border-gray-200 shadow-sm">
  <div class="flex items-center gap-3">
    <div class="w-10 h-10 rounded-lg bg-indigo-600 flex items-center justify-center">
      <i class="fas fa-fingerprint text-white text-lg"></i>
    </div>
    <div>
      <h1 class="text-gray-900 font-bold text-lg">FaceTrack</h1>
      <p class="text-xs text-gray-500">Kiosk Mode</p>
    </div>
  </div>

  <div class="flex items-center gap-4">
    <div id="currentTime" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-900 font-semibold text-sm"></div>
    
    <button id="openSettingsBtn" class="w-10 h-10 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
      <i class="fas fa-cog text-gray-600"></i>
    </button>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="h-[calc(100vh-64px)] p-6 overflow-auto bg-gray-50">
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- LEFT: CAMERA -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center gap-2 mb-4">
        <div class="w-2 h-2 rounded-full bg-green-500"></div>
        <h2 class="text-lg font-semibold text-gray-900">Camera Feed</h2>
      </div>
      <p class="text-sm text-gray-500 text-center mb-4">
        Position your face in the camera view
      </p>

      <!-- Camera Container -->
      <div class="relative aspect-video rounded-lg bg-gray-900 overflow-hidden border border-gray-300">
        <video id="kioskVideo" muted playsinline class="w-full h-full object-cover"></video>

        <!-- Scan Overlay -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
          <div id="scanRing" class="relative w-48 h-48 rounded-full border-4 border-gray-500 flex items-center justify-center transition-all duration-500">
            <div class="text-center">
              <i class="fas fa-video-slash text-4xl text-gray-400 mb-2"></i>
              <p id="scanStatusText" class="text-white font-semibold text-sm">
                CAMERA OFF
              </p>
              <p id="scanSubText" class="text-gray-300 text-xs mt-1">
                Start camera to begin
              </p>
            </div>
          </div>
        </div>

        <!-- Corner Indicators -->
        <div class="absolute top-4 left-4 w-5 h-5 border-l-2 border-t-2 border-gray-400/50 rounded-tl"></div>
        <div class="absolute top-4 right-4 w-5 h-5 border-r-2 border-t-2 border-gray-400/50 rounded-tr"></div>
        <div class="absolute bottom-4 left-4 w-5 h-5 border-l-2 border-b-2 border-gray-400/50 rounded-bl"></div>
        <div class="absolute bottom-4 right-4 w-5 h-5 border-r-2 border-b-2 border-gray-400/50 rounded-br"></div>
      </div>

      <!-- Controls -->
      <div class="mt-6 space-y-4">
        <div class="flex gap-3">
          <button id="startCameraBtn"
                  class="flex-1 btn btn-primary h-12">
            <i class="fas fa-play"></i>
            Start Camera
          </button>
          
          <button id="stopCameraBtn"
                  class="hidden flex-1 btn btn-danger h-12">
            <i class="fas fa-stop"></i>
            Stop Camera
          </button>
        </div>

        <div id="cameraStatusBlock"
             class="flex items-center justify-center gap-2 text-sm font-medium bg-gray-100 rounded-lg p-3 border border-gray-200">
          <span id="statusDot" class="w-3 h-3 rounded-full bg-red-500 shadow-lg animate-pulse-fast"></span>
          <span id="cameraStatus" class="text-gray-700">Camera Off</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: STATUS -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center gap-2 mb-4">
        <div class="w-2 h-2 rounded-full bg-purple-500"></div>
        <h2 class="text-lg font-semibold text-gray-900">Attendance Status</h2>
      </div>
      <p class="text-sm text-gray-500 mb-4">Real-time recognition system</p>

      <!-- Waiting Card -->
      <div id="waiting-block" class="card mb-4 bg-blue-50 border-blue-200">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-indigo-600 flex items-center justify-center text-2xl text-white">
            <i class="fas fa-hourglass-half"></i>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-gray-900">Ready for identification</p>
            <p class="text-sm text-gray-500 mt-1">Please look directly at the camera</p>
          </div>
        </div>
      </div>

      <!-- Unknown Face Card -->
      <div id="unknown-card" class="hidden card mb-4 bg-red-50 border-red-200">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-red-600 flex items-center justify-center text-2xl text-white">
            <i class="fas fa-times"></i>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-gray-900">Face Not Recognized</p>
            <p class="text-sm text-gray-600 mt-1">Please try again or contact admin</p>
          </div>
        </div>
      </div>

      <!-- Employee Card -->
      <div id="employee-card" class="hidden card mb-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 shadow-lg">
        <div class="flex items-center gap-4">
          <img id="emp-photo" src="{{ url_for('static', filename='default_user.png') }}"
               class="w-16 h-16 rounded-xl object-cover border-3 border-green-400 shadow-md">
          <div class="flex-1">
            <p id="emp-name" class="font-bold text-lg text-gray-900">Employee Name</p>
            <p id="emp-dept" class="text-sm text-gray-600 mt-1 font-medium">Department</p>
          </div>
          <span id="emp-status" class="px-4 py-2 rounded-lg font-bold text-sm shadow-md">
            CHECKED IN
          </span>
        </div>
      </div>

      <!-- Placeholder -->
      <p id="resultsPlaceholder" class="text-sm text-gray-400 text-center py-4">
        Recognition results will appear here
      </p>

      <!-- Recent Logs -->
      <div class="mt-4">
        <div class="flex items-center gap-2 mb-3 pb-3 border-b-2 border-gray-200">
          <i class="fas fa-history text-indigo-600 text-lg"></i>
          <h3 class="text-lg font-bold text-gray-900">Recent Activity</h3>
        </div>
        <div id="logs-list" class="space-y-3 max-h-80 overflow-y-auto">
          <!-- Log entries will be added here dynamically -->
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PIN MODAL -->
<div id="pinModal" class="fixed inset-0 bg-black/70 backdrop-blur-md hidden items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
    <!-- Header -->
    <div class="bg-indigo-600 p-6 text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/20 backdrop-blur-sm mb-3">
        <i class="fas fa-lock text-white text-2xl"></i>
      </div>
      <h3 class="text-2xl font-bold text-white mb-1">Admin Verification</h3>
      <p class="text-indigo-100 text-sm">Enter your secure PIN</p>
    </div>

    <!-- Body -->
    <div class="p-8">
      <form id="pinForm" autocomplete="off" onsubmit="pinVerify.click(); return false;">
        <input id="pinInput"
               name="pin"
               type="password"
               maxlength="6"
               aria-label="Admin PIN"
               autocomplete="off"
               class="w-full px-4 py-4 text-center text-2xl font-bold tracking-widest border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all mb-6 bg-gray-50"
               placeholder="••••••">

        <div class="flex gap-4">
          <button id="pinCancel"
                  type="button"
                  class="flex-1 px-6 py-4 bg-white border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-bold rounded-xl transition-all hover:shadow-md">
            <i class="fas fa-times mr-2"></i>Cancel
          </button>
          <button id="pinVerify"
                  type="button"
                  class="flex-1 px-6 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all">
            <i class="fas fa-check-circle mr-2"></i>Verify
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div id="settingsPanel"
  class="fixed inset-y-0 right-0 w-96 bg-white border-l border-gray-200 shadow-lg translate-x-full transition-transform duration-300 z-50 flex flex-col">

  <div class="p-6 border-b border-gray-200 bg-gray-50">
    <h3 class="text-xl font-bold text-gray-900 mb-1">Kiosk Settings</h3>
    <p class="text-sm text-gray-500">Administrator controls</p>
  </div>

  <div class="p-6 space-y-4 overflow-y-auto flex-1">
    <!-- Camera Selection -->
    <div class="card">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-video text-indigo-600 mr-2"></i>
        Camera Device
      </label>
      <select id="adminCameraSelect" class="input w-full"></select>
    </div>
    
    <!-- Voice Toggle -->
    <div id="voiceToggle" class="card cursor-pointer hover:bg-gray-50 transition-colors">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-volume-up text-indigo-600 text-lg"></i>
          <span class="font-semibold text-gray-700">Enable Voice</span>
        </div>
        <div class="toggle-switch w-12 h-6 bg-green-500 rounded-full flex items-center px-1 transition-colors">
          <div class="toggle-knob w-5 h-5 bg-white rounded-full translate-x-6 transition-transform shadow-sm"></div>
        </div>
      </div>
    </div>

    <!-- Camera Status Toggle -->
    <div id="cameraStatusToggle" class="card cursor-pointer hover:bg-gray-50 transition-colors">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-info-circle text-indigo-600 text-lg"></i>
          <span class="font-semibold text-gray-700">Show Camera Status</span>
        </div>
        <div class="toggle-switch w-12 h-6 bg-green-500 rounded-full flex items-center px-1 transition-colors">
          <div class="toggle-knob w-5 h-5 bg-white rounded-full translate-x-6 transition-transform shadow-sm"></div>
        </div>
      </div>
    </div>

    <!-- Camera Switch Toggle -->
    <div id="cameraSwitchToggle" class="card cursor-pointer hover:bg-gray-50 transition-colors">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-exchange-alt text-indigo-600 text-lg"></i>
          <span class="font-semibold text-gray-700">Allow Camera Switch</span>
        </div>
        <div class="toggle-switch w-12 h-6 bg-green-500 rounded-full flex items-center px-1 transition-colors">
          <div class="toggle-knob w-5 h-5 bg-white rounded-full translate-x-6 transition-transform shadow-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="p-6 border-t border-gray-200 space-y-3">
    <button id="exitKioskBtn" class="w-full btn btn-danger">
      <i class="fas fa-sign-out-alt"></i>
      Exit Kiosk
    </button>

    <button id="closeSettingsBtn" class="w-full btn btn-secondary">
      <i class="fas fa-times"></i>
      Close Settings
    </button>
  </div>
</div>

<style>
/* Minimal animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

/* Toggle switch styling */
.toggle-switch.off {
  background-color: #d1d5db;
}

.toggle-switch.off .toggle-knob {
  transform: translateX(0);
}
</style>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/kiosk.js') }}"></script>
<script>
// Kiosk mode: Intercept back button and show PIN modal
let backButtonPressed = false;

history.pushState(null, '', location.href);
window.addEventListener('popstate', function(e) {
  // Prevent actual navigation
  history.pushState(null, '', location.href);
  
  // Show PIN modal for exit
  backButtonPressed = true;
  const pinModal = document.getElementById('pinModal');
  const pinInput = document.getElementById('pinInput');
  
  if (pinModal && pinInput) {
    window.pendingExit = true; // Set flag for exit (used by kiosk.js)
    pinInput.value = '';
    pinModal.classList.remove('hidden');
    pinModal.classList.add('flex');
    setTimeout(() => pinInput.focus(), 100);
  }
});
</script>
{% endblock %}