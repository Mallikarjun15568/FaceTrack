{% extends "base.html" %}
{% block page_title %}Employees{% endblock %}
{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
.employees-table-container::-webkit-scrollbar {
  width: 12px !important;
  height: 12px !important;
}
.employees-table-container::-webkit-scrollbar-track {
  background: #f1f1f1 !important;
  border-radius: 6px !important;
}
.employees-table-container::-webkit-scrollbar-thumb {
  background: #c1c1c1 !important;
  border-radius: 6px !important;
}
.employees-table-container::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1 !important;
}
.employees-table-container {
  scrollbar-width: auto !important;
  -ms-overflow-style: auto !important;
}
</style>
{% endblock %}
{% block content %}

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Employees</h1>
      <p class="text-sm text-gray-500 mt-1">Manage employee records and access</p>
    </div>

    <div class="flex items-center gap-3 w-full lg:w-auto">
      <!-- SEARCH -->
      <div class="flex items-center gap-2 bg-white border border-gray-300 rounded-lg px-3 py-2 flex-1 lg:w-80">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input id="globalSearch" type="text" placeholder="Search employees..."
               class="flex-1 outline-none text-sm bg-transparent" />
        <button id="clearSearch" class="text-gray-400 hover:text-gray-700">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>

      <a href="/employees/add" class="btn btn-primary whitespace-nowrap">
        <i class="fas fa-plus"></i>Add Employee
      </a>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="card mb-8 flex flex-col md:flex-row gap-4 items-center justify-between">

    <div class="flex gap-3 items-center flex-wrap">

      <select id="filterDept" class="input-premium text-sm">
        <option value="">All Departments</option>
        {% for d in departments %}
          <option value="{{ d.id }}"
            {% if request.args.get('department_id') == (d.id|string) %} selected {% endif %}>
            {{ d.name }}
          </option>
        {% endfor %}
      </select>

      <select id="filterEnroll" class="input-premium text-sm">
        <option value="">Enrollment Status</option>
        <option value="enrolled" {% if request.args.get('enrolled')=='enrolled' %}selected{% endif %}>Enrolled</option>
        <option value="not_enrolled" {% if request.args.get('enrolled')=='not_enrolled' %}selected{% endif %}>Not Enrolled</option>
      </select>

      <select id="sortBy" class="input-premium text-sm">
        <option value="newest"     {% if sort=='newest' %}selected{% endif %}>Newest First</option>
        <option value="oldest"     {% if sort=='oldest' %}selected{% endif %}>Oldest First</option>
        <option value="name_asc"   {% if sort=='name_asc' %}selected{% endif %}>Name A–Z</option>
        <option value="name_desc"  {% if sort=='name_desc' %}selected{% endif %}>Name Z–A</option>
      </select>

      <button id="applyFilters" class="btn btn-primary">
        <i class="fas fa-filter"></i>Apply
      </button>
      <button id="resetFilters" class="btn btn-secondary">
        <i class="fas fa-redo"></i>Reset
      </button>

    </div>

    <!-- Bulk delete UI removed -->

  </div>

  <!-- TABLE -->
  <div class="card" style="max-height: 600px; overflow: scroll; overflow-x: scroll; overflow-y: scroll; scrollbar-width: thin; -ms-overflow-style: scrollbar;">
    <table class="table w-full" style="min-width: 1000px;">
      <thead>
        <tr>
          <th class="rounded-tl-lg"></th>
          <th>Photo</th>
          <th>Name</th>
          <th>Email</th>
          <th>Department</th>
          <th>Phone</th>
          <th>Join Date</th>
          <th>Enrollment</th>
          <th class="rounded-tr-lg">Actions</th>
        </tr>
      </thead>

      <tbody id="employeesTbody">
        {% for emp in employees %}
        <tr>

          <td></td>

          <td>
            {% set emp_photo_path = emp.photo_path %}
            {% if emp_photo_path and not emp_photo_path.startswith('/') %}
              {% set emp_photo_path = '/' ~ emp_photo_path %}
            {% endif %}
            <img src="{{ emp_photo_path if emp_photo_path else url_for('static', filename='default_user.png') }}"
                 class="w-12 h-12 rounded-lg object-cover border-2 border-gray-200">
          </td>

          <td class="font-semibold text-gray-900">{{ emp.full_name }}</td>
          <td class="text-gray-600">{{ emp.email }}</td>
          <td class="text-gray-700">{{ emp.department or '-' }}</td>
          <td class="text-gray-600">{{ emp.phone or '-' }}</td>
          <td class="text-gray-600">{{ emp.join_date or '-' }}</td>

          <td>
            {% if emp.enrolled %}
              <span class="badge badge-success">✓ Enrolled</span>
            {% else %}
              <span class="badge badge-secondary">Not Enrolled</span>
            {% endif %}
          </td>

          <td class="flex gap-2 items-center">
            <a href="/employees/view/{{ emp.id }}" class="text-indigo-600 hover:text-indigo-700 font-medium">View</a>
            {% if current_role != 'employee' %}
            <a href="/employees/edit/{{ emp.id }}" class="text-green-600 hover:text-green-700 font-medium">Edit</a>
            <!-- Status badge and action button with string comparison -->
            {% if emp.status == 'active' %}
              <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">Active</span>
              <button onclick="toggleEmployee({{ emp.id }}, 'deactivate')"
                      class="bg-orange-500 text-white px-3 py-1 rounded-full text-xs ml-2">
                Deactivate
              </button>
            {% else %}
              <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs">Inactive</span>
              <button onclick="toggleEmployee({{ emp.id }}, 'activate')"
                      class="bg-green-500 text-white px-3 py-1 rounded-full text-xs ml-2">
                Activate
              </button>
            {% endif %}
            {% endif %}
          </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>

  <!-- PAGINATION -->
  <div class="flex items-center justify-between card">
    <div class="text-sm text-gray-600">
      Showing <span class="text-indigo-600 font-bold">{{ start + 1 }}</span> – <span class="text-indigo-600 font-bold">{{ (end if end < total else total) }}</span> of <span class="text-indigo-600 font-bold">{{ total }}</span> employees
    </div>

    <div class="flex items-center gap-2">

      {% if page > 1 %}
        <a href="?page={{ page - 1 }}&{{ querystring }}" class="btn btn-secondary">← Prev</a>
      {% endif %}

      <div class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg font-bold">{{ page }}</div>

      {% if end < total %}
        <a href="?page={{ page + 1 }}&{{ querystring }}" class="btn btn-secondary">Next →</a>
      {% endif %}

    </div>
  </div>

</div>

<script src="/static/js/employees.js"></script>

<!-- Deactivate Modal -->
<div id="deactivateModal" class="fixed inset-0 z-50 hidden pointer-events-auto">
  <div class="fixed inset-0 bg-black/40" onclick="closeDeactivateModal()"></div>
  <div class="fixed inset-0 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl w-[420px] p-6 animate-scaleIn pointer-events-auto">
      <div class="flex items-center justify-center w-14 h-14 rounded-full bg-orange-100 mx-auto mb-4">
        <span class="text-orange-600 text-3xl">!</span>
      </div>
      <h2 class="text-xl font-semibold text-center text-gray-800">
        Deactivate Employee
      </h2>
      <p class="text-sm text-gray-600 text-center mt-3 leading-relaxed">
        This will temporarily disable the employee account.<br><br>
        <b>Login, attendance and leave access will be blocked.</b><br><br>
        <span class="text-green-600 font-medium">
          Employee data will NOT be deleted.
        </span>
      </p>
      <div class="flex justify-center gap-4 mt-6">
        <button
          id="confirmDeactivateBtn"
          class="px-5 py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-medium">
          Deactivate
        </button>
        <button
          onclick="closeDeactivateModal()"
          class="px-5 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
