<!-- Leave Management - Leave List Page -->
<!-- File: templates/leave/leave_list.html -->

{% extends "base.html" %}

{% block title %}Leave Management{% endblock %}

{% block extra_head %}
<style>
.leave-table-container::-webkit-scrollbar {
  width: 12px !important;
  height: 12px !important;
}
.leave-table-container::-webkit-scrollbar-track {
  background: #f1f1f1 !important;
  border-radius: 6px !important;
}
.leave-table-container::-webkit-scrollbar-thumb {
  background: #c1c1c1 !important;
  border-radius: 6px !important;
}
.leave-table-container::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1 !important;
}
.leave-table-container {
  scrollbar-width: auto !important;
  -ms-overflow-style: auto !important;
}
</style>
{% endblock %}

{% block content %}
<div class="py-8">
    <div class="max-w-7xl mx-auto px-4">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-8 scroll-reveal">
            <div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">Leave Management</h1>
                <p class="text-gray-600 mt-2 font-medium flex items-center gap-2">
                    <i class="fas fa-calendar-check text-indigo-600"></i>
                    Manage time-off requests and team availability
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="showCalendarView()" class="btn bg-white border-2 border-gray-300 text-gray-700 hover:border-indigo-600 hover:text-indigo-600 flex items-center gap-2">
                    <i class="far fa-calendar-alt"></i>
                    Calendar View
                </button>
                {% if role in ['employee', 'admin', 'hr'] %}
                <a href="{{ url_for('leave.apply') }}" class="btn-premium btn-premium-primary flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i>
                    Apply Leave
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Leave Balance Cards -->
        {% if balance %}
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <!-- Casual Leave -->
            <div class="premium-card p-6 border-l-4 border-blue-500 scroll-reveal" style="--delay: 0.1s">
                <p class="text-sm text-gray-600">Casual Leave</p>
                <p class="text-3xl font-bold text-gray-900">{{ balance.casual_leave }}</p>
                <p class="text-xs text-gray-500 mt-1">days remaining</p>
            </div>
            <!-- Sick Leave -->
            <div class="premium-card p-6 border-l-4 border-red-500 scroll-reveal" style="--delay: 0.2s">
                <p class="text-sm text-gray-600">Sick Leave</p>
                <p class="text-3xl font-bold text-gray-900">{{ balance.sick_leave }}</p>
                <p class="text-xs text-gray-500 mt-1">days remaining</p>
            </div>
            <!-- Vacation Leave -->
            <div class="premium-card p-6 border-l-4 border-green-500 scroll-reveal" style="--delay: 0.3s">
                <p class="text-sm text-gray-600">Vacation Leave</p>
                <p class="text-3xl font-bold text-gray-900">{{ balance.vacation_leave }}</p>
                <p class="text-xs text-gray-500 mt-1">days remaining</p>
            </div>
            <!-- Work From Home -->
            <div class="premium-card p-6 border-l-4 border-purple-500 scroll-reveal" style="--delay: 0.4s">
                <p class="text-sm text-gray-600">Work From Home</p>
                <p class="text-3xl font-bold text-gray-900">{{ balance.emergency_leave }}</p>
                <p class="text-xs text-gray-500 mt-1">days remaining</p>
            </div>
        </div>
        {% endif %}

        <!-- Admin-only Leave Balance Adjustment Section -->
        {% if role in ['admin', 'hr'] %}
        <div class="premium-card p-6 mb-8 scroll-reveal" style="--delay: 0.15s">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                    <i class="fas fa-balance-scale"></i>
                    Leave Balance Adjustment
                </h2>
                <span class="text-xs text-gray-500 italic">Leave balance adjustments are handled by administrators within the Leave Management module to ensure policy control and prevent misuse.</span>
            </div>
            <form method="POST" action="{{ url_for('leave.adjust_balance') }}" class="flex flex-wrap gap-4 items-end" id="adjustBalanceForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Employee</label>
                    <select name="employee_id" required class="border-2 border-gray-300 rounded-lg p-2 min-w-[180px]">
                        <option value="" disabled selected>Select employee</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Leave Type</label>
                    <select name="leave_type" required class="border-2 border-gray-300 rounded-lg p-2">
                        <option value="" disabled selected>Select type</option>
                        <option value="casual_leave">Casual</option>
                        <option value="sick_leave">Sick</option>
                        <option value="vacation_leave">Vacation</option>
                        <option value="emergency_leave">Emergency</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Operation</label>
                    <select name="operation" required class="border-2 border-gray-300 rounded-lg p-2">
                        <option value="add">Add Days</option>
                        <option value="reduce">Reduce Days</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Days</label>
                    <input type="number" name="days" required min="0" class="border-2 border-gray-300 rounded-lg p-2 w-24" placeholder="5">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Reason (optional)</label>
                    <input type="text" name="reason" class="border-2 border-gray-300 rounded-lg p-2 min-w-[180px]" placeholder="Reason">
                </div>
                <button type="submit" class="btn-premium btn-premium-primary flex items-center gap-2">
                    <i class="fas fa-edit"></i>
                    Adjust Balance
                </button>
            </form>
        </div>
        {% endif %}

        <!-- Filters and Search -->
        <div class="premium-card p-6 mb-6 scroll-reveal" style="--delay: 0.2s">
            <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                <div class="flex flex-col sm:flex-row gap-4 flex-1">
                    <!-- Status Filter -->
                    <div class="min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <!-- Employee Filter (Admin only) -->
                    {% if role in ['admin', 'hr'] %}
                    <div class="min-w-[180px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
                        <select id="employeeFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Employees</option>
                            {% for emp in employees %}
                            <option value="{{ emp.id }}">{{ emp.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <!-- Date Range Filter -->
                    <div class="min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                        <input type="date" id="fromDateFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                        <input type="date" id="toDateFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="clearFilters()" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-times mr-2"></i>Clear
                    </button>
                    <button onclick="applyFilters()" class="btn-premium btn-premium-primary px-4 py-2">
                        <i class="fas fa-search mr-2"></i>Filter
                    </button>
                </div>
            </div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-50 text-green-800 border border-green-200{% else %}bg-red-50 text-red-800 border border-red-200{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Leave Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 scroll-reveal" style="--delay: 0.25s">
            <div class="premium-card p-4 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Pending</p>
                        <p class="text-2xl font-bold text-yellow-600" id="pendingCount">0</p>
                    </div>
                    <i class="fas fa-clock text-yellow-500 text-2xl"></i>
                </div>
            </div>
            <div class="premium-card p-4 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Approved</p>
                        <p class="text-2xl font-bold text-green-600" id="approvedCount">0</p>
                    </div>
                    <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                </div>
            </div>
            <div class="premium-card p-4 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Rejected</p>
                        <p class="text-2xl font-bold text-red-600" id="rejectedCount">0</p>
                    </div>
                    <i class="fas fa-times-circle text-red-500 text-2xl"></i>
                </div>
            </div>
            <div class="premium-card p-4 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalCount">0</p>
                    </div>
                    <i class="fas fa-calendar-alt text-blue-500 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Leaves Table -->
        <div class="premium-card overflow-hidden scroll-reveal" style="--delay: 0.5s">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    {% if role in ['admin', 'hr'] %}All Leave Applications{% else %}My Leave Applications{% endif %}
                </h2>
            </div>

            <div class="overflow-x-auto">
                <table class="table-premium min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            {% if role in ['admin', 'hr'] %}
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                            {% endif %}
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Duration</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Reason</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="leaveTableBody">
                        {% for leave in leaves %}
                        <tr class="hover:bg-gray-50" data-status="{{ leave.status }}" data-employee-id="{% if role in ['admin', 'hr'] %}{{ leave.employee_id }}{% endif %}" data-start-date="{{ leave.start_date }}" data-end-date="{{ leave.end_date }}">
                            {% if role in ['admin', 'hr'] %}
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="h-8 w-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                        <span class="text-white font-semibold text-sm">
                                            {{ leave.employee_name[:1] }}
                                        </span>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ leave.employee_name }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            {% endif %}

                            <td class="px-4 py-4">
                                <div class="flex items-center">
                                    {% if leave.leave_type == 'Casual Leave' %}
                                    <i class="fas fa-briefcase text-blue-500 mr-2"></i>
                                    {% elif leave.leave_type == 'Sick Leave' %}
                                    <i class="fas fa-thermometer-half text-red-500 mr-2"></i>
                                    {% elif leave.leave_type == 'Vacation Leave' %}
                                    <i class="fas fa-plane text-green-500 mr-2"></i>
                                    {% else %}
                                    <i class="fas fa-home text-purple-500 mr-2"></i>
                                    {% endif %}
                                    <span class="text-sm font-medium">{{ leave.leave_type }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-4 hidden sm:table-cell">
                                <div class="text-sm text-gray-900">{{ leave.start_date }}</div>
                                <div class="text-sm text-gray-500">to {{ leave.end_date }}</div>
                            </td>
                            <td class="px-4 py-4">
                                <span class="text-sm font-semibold text-gray-900">{{ leave.total_days }}</span>
                                <span class="text-xs text-gray-500 block sm:hidden">days</span>
                            </td>
                            <td class="px-4 py-4 hidden md:table-cell">
                                <span class="text-sm text-gray-900 truncate block max-w-xs" title="{{ leave.reason }}">
                                    {{ leave.reason[:50] }}{% if leave.reason|length > 50 %}...{% endif %}
                                </span>
                            </td>

                            <td class="px-4 py-4">
                                {% if leave.status == 'approved' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Approved
                                </span>
                                {% elif leave.status == 'rejected' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    Rejected
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-clock mr-1"></i>
                                    Pending
                                </span>
                                {% endif %}
                            </td>

                            <td class="px-4 py-4 text-sm">
                                {% if leave.status == 'pending' %}
                                    {% if role in ['admin', 'hr'] %}
                                    <div class="flex flex-col sm:flex-row gap-1">
                                        <form method="POST" action="{{ url_for('leave.approve', leave_id=leave.id) }}" class="inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="w-full sm:w-auto px-3 py-1.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium text-xs flex items-center justify-center gap-1">
                                                <i class="fas fa-check"></i>
                                                <span class="hidden sm:inline">Approve</span>
                                            </button>
                                        </form>
                                        <button onclick="showRejectModal('{{ leave.id }}')" class="w-full sm:w-auto px-3 py-1.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium text-xs flex items-center justify-center gap-1">
                                            <i class="fas fa-times"></i>
                                            <span class="hidden sm:inline">Reject</span>
                                        </button>
                                    </div>
                                    {% else %}
                                    <form method="POST" action="{{ url_for('leave.cancel', leave_id=leave.id) }}" class="inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="w-full px-3 py-1.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium text-xs flex items-center justify-center gap-1">
                                            <i class="fas fa-ban"></i>
                                            <span class="hidden sm:inline">Cancel</span>
                                        </button>
                                    </form>
                                    {% endif %}
                                {% else %}
                                <span class="text-gray-400 text-xs">No action</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}

                        {% if not leaves %}
                        <tr>
                            <td colspan="{% if role in ['admin','hr'] %}7{% else %}6{% endif %}"
                                class="px-6 py-12 text-center text-gray-500">
                                No leave applications found
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center" onclick="if(event.target === this) hideRejectModal()">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-times-circle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Reject Leave</h3>
        </div>
        
        <form method="POST" id="rejectForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Rejection Reason</label>
            <textarea name="rejection_reason" rows="4" required
                class="w-full border-2 border-gray-300 rounded-xl p-4 focus:border-red-500 focus:ring-2 focus:ring-red-200 transition-all"
                placeholder="Please provide a detailed reason for rejection..."></textarea>
            
            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
                    <i class="fas fa-ban mr-2"></i>
                    Reject Leave
                </button>
                <button type="button" onclick="hideRejectModal()"
                    class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

        <!-- Team Leave Calendar (Hidden by default) -->
        <div id="leaveCalendarSection" class="hidden mb-8">
            <div class="premium-card overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-purple-600"></i>
                            Team Leave Calendar
                        </h3>
                        <div class="flex items-center gap-2">
                            <button id="prevMonth" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h4 id="calendarMonth" class="font-bold text-gray-900 min-w-[140px] text-center">January 2026</h4>
                            <button id="nextMonth" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <!-- Weekdays -->
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <div class="text-center font-bold text-gray-700 text-sm">Sun</div>
                        <div class="text-center font-bold text-gray-700 text-sm">Mon</div>
                        <div class="text-center font-bold text-gray-700 text-sm">Tue</div>
                        <div class="text-center font-bold text-gray-700 text-sm">Wed</div>
                        <div class="text-center font-bold text-gray-700 text-sm">Thu</div>
                        <div class="text-center font-bold text-gray-700 text-sm">Fri</div>
                        <div class="text-center font-bold text-gray-700 text-sm">Sat</div>
                    </div>

                    <!-- Calendar Grid -->
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2 auto-rows-[80px] mb-6">
                        <!-- Calendar will be populated by JavaScript -->
                    </div>

                    <!-- Upcoming Leaves -->
                    <div class="border-t pt-6">
                        <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-list text-indigo-600"></i>
                            Upcoming Leaves
                        </h4>
                        <div id="upcomingLeaves" class="space-y-2">
                            <!-- Upcoming leaves list -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

<script>
// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateStatistics();
});

// Filter functions
function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const employeeFilter = document.getElementById('employeeFilter')?.value || '';
    const fromDate = document.getElementById('fromDateFilter').value;
    const toDate = document.getElementById('toDateFilter').value;
    
    const rows = document.querySelectorAll('#leaveTableBody tr');
    
    rows.forEach(row => {
        let show = true;
        
        // Status filter
        if (statusFilter && row.dataset.status !== statusFilter) {
            show = false;
        }
        
        // Employee filter
        if (employeeFilter && row.dataset.employeeId !== employeeFilter) {
            show = false;
        }
        
        // Date range filter
        if (fromDate || toDate) {
            const startDate = new Date(row.dataset.startDate);
            const endDate = new Date(row.dataset.endDate);
            
            if (fromDate) {
                const filterFrom = new Date(fromDate);
                if (endDate < filterFrom) show = false;
            }
            
            if (toDate) {
                const filterTo = new Date(toDate);
                if (startDate > filterTo) show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
    
    updateStatistics();
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    if (document.getElementById('employeeFilter')) {
        document.getElementById('employeeFilter').value = '';
    }
    document.getElementById('fromDateFilter').value = '';
    document.getElementById('toDateFilter').value = '';
    
    const rows = document.querySelectorAll('#leaveTableBody tr');
    rows.forEach(row => row.style.display = '');
    
    updateStatistics();
}

function updateStatistics() {
    const rows = document.querySelectorAll('#leaveTableBody tr:not([style*="display: none"])');
    let pending = 0, approved = 0, rejected = 0, total = 0;
    
    rows.forEach(row => {
        total++;
        const status = row.dataset.status;
        if (status === 'pending') pending++;
        else if (status === 'approved') approved++;
        else if (status === 'rejected') rejected++;
    });
    
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('rejectedCount').textContent = rejected;
    document.getElementById('totalCount').textContent = total;
}
let currentCalendarYear = new Date().getFullYear();
let currentCalendarMonth = new Date().getMonth() + 1;

function showRejectModal(id) {
    document.getElementById('rejectForm').action = '/leave/reject/' + id;
    document.getElementById('rejectModal').classList.remove('hidden');
}

function hideRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
}

function showCalendarView() {
    const calendarSection = document.getElementById('leaveCalendarSection');
    const isHidden = calendarSection.classList.contains('hidden');

    if (isHidden) {
        calendarSection.classList.remove('hidden');
        loadCalendar();
        // Update button text
        const button = document.querySelector('button[onclick="showCalendarView()"]');
        if (button) {
            button.innerHTML = '<i class="far fa-calendar-alt"></i> Hide Calendar';
            button.onclick = hideCalendarView;
        }
    } else {
        hideCalendarView();
    }
}

function hideCalendarView() {
    document.getElementById('leaveCalendarSection').classList.add('hidden');
    // Update button text
    const button = document.querySelector('button[onclick="hideCalendarView()"]');
    if (button) {
        button.innerHTML = '<i class="far fa-calendar-alt"></i> Calendar View';
        button.onclick = showCalendarView;
    }
}

function loadCalendar(year = null, month = null) {
    if (year !== null) currentCalendarYear = year;
    if (month !== null) currentCalendarMonth = month;

    fetch(`/leave/api/calendar?year=${currentCalendarYear}&month=${currentCalendarMonth}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                renderLeaveCalendar(currentCalendarYear, currentCalendarMonth, data.calendar);
                updateMonthDisplay();
            }
        })
        .catch(err => console.error("Failed to load leave calendar:", err));
}

function changeMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
    }
    loadCalendar();
}

function updateMonthDisplay() {
    const monthNames = ["January", "February", "March", "April", "May", "June",
                       "July", "August", "September", "October", "November", "December"];
    document.getElementById('calendarMonth').textContent = `${monthNames[currentCalendarMonth - 1]} ${currentCalendarYear}`;
}

function renderLeaveCalendar(year, month, calendarData) {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = new Date(year, month, 0).getDate();

    // Create a map of date -> leave data
    const leaveMap = {};
    calendarData.forEach(day => {
        leaveMap[day.date] = day;
    });

    // Empty cells before month starts
    for (let i = 0; i < firstDay; i++) {
        const cell = document.createElement('div');
        cell.className = 'h-20 rounded-lg bg-gray-50';
        grid.appendChild(cell);
    }

    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dayData = leaveMap[dateStr] || { employees_on_leave: [], leave_count: 0 };
        const employeesOnLeave = dayData.employees_on_leave || [];

        const cell = document.createElement('div');
        cell.className = 'h-20 rounded-lg border border-gray-200 p-2 hover:border-indigo-400 transition-all';

        // Highlight today
        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() + 1 && year === today.getFullYear()) {
            cell.className += ' border-indigo-600 bg-indigo-50';
        }

        // Color based on leave count
        if (employeesOnLeave.length > 0) {
            if (employeesOnLeave.length === 1) {
                cell.className += ' bg-blue-50 border-blue-300';
            } else if (employeesOnLeave.length <= 3) {
                cell.className += ' bg-yellow-50 border-yellow-300';
            } else {
                cell.className += ' bg-red-50 border-red-300';
            }
        }

        // Create content
        let content = `<div class="font-bold text-gray-900 text-sm">${day}</div>`;

        if (employeesOnLeave.length > 0) {
            content += `<div class="text-xs text-blue-600 font-medium mt-1">${employeesOnLeave.length} on leave</div>`;

            // Show first 2 employees
            const displayEmployees = employeesOnLeave.slice(0, 2);
            displayEmployees.forEach(emp => {
                const leaveTypeShort = emp.leave_type === 'casual_leave' ? 'CL' :
                                     emp.leave_type === 'sick_leave' ? 'SL' :
                                     emp.leave_type === 'vacation_leave' ? 'VL' : 'WFH';
                content += `<div class="text-xs text-gray-600 truncate" title="${emp.employee_name}">${emp.employee_name.split(' ')[0]}</div>`;
            });

            if (employeesOnLeave.length > 2) {
                content += `<div class="text-xs text-gray-500">+${employeesOnLeave.length - 2} more</div>`;
            }
        } else {
            content += `<div class="text-xs text-gray-400 mt-1">No leaves</div>`;
        }

        cell.innerHTML = content;
        grid.appendChild(cell);
    }

    // Update upcoming leaves section
    renderUpcomingLeaves(calendarData);
}

function renderUpcomingLeaves(calendarData) {
    const upcomingDiv = document.getElementById('upcomingLeaves');

    // Get upcoming leaves (next 7 days)
    const today = new Date();
    const upcomingLeaves = [];

    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];

        const dayData = calendarData.find(d => d.date === dateStr);
        if (dayData && dayData.employees_on_leave && dayData.employees_on_leave.length > 0) {
            upcomingLeaves.push({
                date: date,
                employees: dayData.employees_on_leave
            });
        }
    }

    if (upcomingLeaves.length === 0) {
        upcomingDiv.innerHTML = '<div class="text-center py-8"><div class="text-gray-400 text-sm">No upcoming leaves</div><div class="text-gray-300 text-xs mt-1">All team members are available</div></div>';
        return;
    }

    let html = '';
    upcomingLeaves.forEach(day => {
        const date = day.date;
        const formattedDate = date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        });

        const isToday = date.toDateString() === new Date().toDateString();
        const isTomorrow = new Date(date.getTime() - 24 * 60 * 60 * 1000).toDateString() === new Date().toDateString();

        let dateLabel = formattedDate;
        if (isToday) dateLabel = 'Today';
        else if (isTomorrow) dateLabel = 'Tomorrow';

        html += `
            <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 hover:border-indigo-300 transition-all">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-calendar-day text-blue-600 text-xs"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="font-medium text-gray-900 ${isToday ? 'text-indigo-600' : ''}">${dateLabel}</div>
                        <div class="text-xs text-gray-500">${day.employees.length} leave${day.employees.length > 1 ? 's' : ''}</div>
                    </div>
                </div>
                <div class="text-right">
                    ${day.employees.slice(0, 2).map(emp => `<div class="text-xs text-gray-600">${emp.employee_name.split(' ')[0]}</div>`).join('')}
                    ${day.employees.length > 2 ? `<div class="text-xs text-gray-500">+${day.employees.length - 2} more</div>` : ''}
                </div>
            </div>
        `;
    });

    upcomingDiv.innerHTML = html;
}

// Initialize calendar navigation
document.addEventListener('DOMContentLoaded', function() {
    // Previous month button
    document.getElementById('prevMonth').addEventListener('click', function() {
        changeMonth(-1);
    });

    // Next month button
    document.getElementById('nextMonth').addEventListener('click', function() {
        changeMonth(1);
    });
});
</script>
{% endblock %}
