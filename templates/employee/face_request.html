<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Request - FaceTrack Employee</title>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/professional.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/premium.css') }}">

  <!-- Icons: prefer local copy (if available), otherwise use CDN -->
  {% if FA_LOCAL_AVAILABLE %}
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/css/all.min.css') }}">
  {% else %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  {% endif %}

  <style>
    body { font-family: 'Inter', sans-serif; }
    .admin-bg {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      background-image:
        radial-gradient(circle at 25% 25%, rgba(37, 99, 235, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(37, 99, 235, 0.02) 0%, transparent 50%);
    }
    .premium-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .premium-card:hover {
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      transform: translateY(-2px);
    }
    .stat-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 0.75rem;
      padding: 0.75rem;
    }
    .action-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      color: white;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    .action-btn-secondary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .scroll-reveal {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease-out forwards;
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* Header uses internal h-16; page layout handles top spacing */
  </style>
</head>
<body class="m-0 bg-soft-mist min-h-screen">

  <!-- Premium Header -->
    <header class="fixed top-0 inset-x-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100 shadow-sm">
      <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
        <!-- Logo only (compact) -->
        <div class="flex items-center gap-2">
          <a href="/" class="block">
            <img src="{{ url_for('static', filename='images/FaceTrack_logo.png') }}" alt="FaceTrack Logo" class="h-16 w-auto">
          </a>
        </div>

        <!-- Navigation Menu -->
        <nav class="flex items-center gap-6">
          <a href="{{ url_for('employee.dashboard') }}" class="text-sm font-medium transition-colors px-3 py-2 rounded-lg hover:bg-blue-50 {% if request.endpoint == 'employee.dashboard' %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:text-blue-600{% endif %}">
            <i class="fas fa-home mr-2"></i>Dashboard
          </a>
          <a href="{{ url_for('employee.attendance') }}" class="text-sm font-medium transition-colors px-3 py-2 rounded-lg hover:bg-blue-50 {% if request.endpoint == 'employee.attendance' %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:text-blue-600{% endif %}">
            <i class="fas fa-clipboard-list mr-2"></i>Attendance
          </a>
          <a href="{{ url_for('employee.face_request') }}" class="text-sm font-medium transition-colors px-3 py-2 rounded-lg hover:bg-blue-50 {% if request.endpoint == 'employee.face_request' %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:text-blue-600{% endif %}">
            <i class="fas fa-camera mr-2"></i>Face Request
          </a>
          <a href="{{ url_for('employee.leave') }}" class="text-sm font-medium transition-colors px-3 py-2 rounded-lg hover:bg-blue-50 {% if request.endpoint == 'employee.leave' %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:text-blue-600{% endif %}">
            <i class="fas fa-calendar-plus mr-2"></i>Leave
          </a>
          <a href="{{ url_for('employee.summary') }}" class="text-sm font-medium transition-colors px-3 py-2 rounded-lg hover:bg-blue-50 {% if request.endpoint == 'employee.summary' %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:text-blue-600{% endif %}">
            <i class="fas fa-chart-bar mr-2"></i>Summary
          </a>
        </nav>

        <!-- User Section (compact dropdown) -->
        <div class="relative">
          <button id="userMenuBtn" onclick="toggleUserMenu(event)" class="flex items-center gap-3 focus:outline-none">
            <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-sm">
              <i class="fas fa-user text-white text-sm"></i>
            </div>
            <span class="ml-2 hidden sm:inline text-sm font-medium text-gray-800">{{ session.get('full_name', 'Employee') }}</span>
            <i class="fas fa-caret-down ml-1 text-gray-500"></i>
          </button>
          <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white border rounded-lg shadow-md py-2 z-50">
            <a href="{{ url_for('employee.profile') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-user mr-2"></i>Profile</a>
            <a href="{{ url_for('employee.settings') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-cog mr-2"></i>Settings</a>
            <form action="{{ url_for('auth.logout') }}" method="post" style="display: inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-50"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <script>
      function toggleUserMenu(e){ e.stopPropagation(); const m=document.getElementById('userMenu'); if(m) m.classList.toggle('hidden'); }
      document.addEventListener('click', function(){ const m=document.getElementById('userMenu'); if(m && !m.classList.contains('hidden')) m.classList.add('hidden'); });
    </script>

  <!-- Main Content -->
  <div class="pt-24 pb-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Page Header -->
      <div class="premium-card p-6 mb-6 scroll-reveal">
        <div class="flex items-center gap-4">
          <div class="w-11 h-11 bg-blue-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-camera text-blue-600 text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-900">Face Recognition Request</h1>
            <p class="text-gray-500 text-sm mt-0.5">Request to enroll or update your face data for attendance system</p>
          </div>
        </div>
      </div>

      <!-- Current Face Status -->
      <div class="premium-card p-5 mb-6 scroll-reveal">
        <h3 class="text-base font-semibold text-gray-900 mb-3">Current Status</h3>
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="flex items-center gap-3">
            {% if pending_request %}
              {% if pending_request.status == 'pending' %}
                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                  <i class="fas fa-clock mr-2 text-xs"></i> Request Pending Approval
                </span>
              {% elif pending_request.status == 'approved' %}
                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-green-100 text-green-800">
                  <i class="fas fa-check mr-2 text-xs"></i> Face Approved
                </span>
              {% elif pending_request.status == 'rejected' %}
                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-red-100 text-red-800">
                  <i class="fas fa-times mr-2 text-xs"></i> Request Rejected
                </span>
              {% endif %}
            {% elif has_face %}
              <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-green-100 text-green-800">
                <i class="fas fa-check mr-2 text-xs"></i> Face Enrolled
              </span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                <i class="fas fa-times mr-2 text-xs"></i> Not Enrolled
              </span>
            {% endif %}
          </div>
          {% if pending_request and pending_request.status == 'pending' %}
            <button id="cancelRequestBtn" class="btn btn-outline-danger text-sm">
              <i class="fas fa-times mr-1.5 text-xs"></i>
              Cancel Request
            </button>
          {% endif %}
        </div>
        {% if pending_request and pending_request.status == 'rejected' and pending_request.rejection_reason %}
          <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-800">
              <strong>Rejection Reason:</strong> {{ pending_request.rejection_reason }}
            </p>
          </div>
        {% endif %}
      </div>

      <!-- Face Request Form -->
      {% if not pending_request or pending_request.status == 'rejected' %}
      <div id="faceRequestSection" class="premium-card p-5 scroll-reveal">
        <h3 class="text-base font-semibold text-gray-900 mb-5">Request Face Enrollment/Update</h3>
        <div class="space-y-5">
          <div class="flex gap-3 flex-wrap">
            <button id="enrollBtn" class="action-btn text-sm {{ 'bg-gray-400 cursor-not-allowed' if has_face else '' }}" {{ 'disabled' if has_face else '' }}>
              <i class="fas fa-plus text-sm"></i>
              New Enrollment
            </button>
            <button id="updateBtn" class="action-btn action-btn-secondary text-sm {{ 'bg-gray-400 cursor-not-allowed' if not has_face else '' }}" {{ 'disabled' if not has_face else '' }}>
              <i class="fas fa-edit text-sm"></i>
              Update Face
            </button>
          </div>

          {% if has_face %}
            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
              <p class="text-sm text-green-800">
                <i class="fas fa-info-circle mr-2"></i>
                Your face is already enrolled. You can request an update if your appearance has changed significantly.
              </p>
            </div>
          {% else %}
            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2 text-xs"></i>
                No face data found. Choose "New Enrollment" to add your face to the attendance system.
              </p>
            </div>
          {% endif %}
        </div>

        <!-- Camera Section -->
        <div id="cameraSection" class="hidden mt-6">
          <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
            <h4 class="text-sm font-semibold text-gray-900 mb-4">Capture Your Face</h4>

            <div class="flex flex-col items-center w-full">
              <div class="relative mb-5 w-full max-w-sm aspect-[4/3] rounded-xl overflow-hidden shadow-lg border border-slate-300">
                <video id="video" autoplay muted class="absolute inset-0 w-full h-full object-cover bg-slate-800"></video>
                <canvas id="faceCanvas" class="absolute inset-0 w-full h-full pointer-events-none hidden" style="z-index: 10;"></canvas>
                <div id="guidanceText" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-lg text-xs font-medium hidden" style="z-index: 20;">
                  Center your face
                </div>
              </div>

              <!-- Camera Controls -->
              <div id="cameraControls" class="flex justify-center gap-3 mb-4 w-full max-w-sm">
                <button id="startCameraBtn" class="btn btn-success text-sm flex-1">
                  <i class="fas fa-video mr-1.5 text-xs"></i>
                  Start Camera
                </button>
                <button id="stopCameraBtn" class="btn btn-danger hidden text-sm flex-1">
                  <i class="fas fa-stop mr-1.5 text-xs"></i>
                  Stop
                </button>
                <button id="captureBtn" class="btn btn-primary hidden text-sm flex-1">
                  <i class="fas fa-camera mr-1.5 text-xs"></i>
                  Capture
                </button>
              </div>

              <div class="text-center w-full max-w-sm">
                <p class="text-xs text-gray-500">Ensure good lighting and position your face clearly in the center.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="hidden mt-6">
          <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
            <h4 class="text-sm font-semibold text-gray-900 mb-4">Preview & Submit Request</h4>
            <div class="text-center mb-5">
              <img id="previewImg" class="max-w-xs mx-auto block rounded-xl shadow-lg border-2 border-green-400" />
            </div>
            <div class="flex justify-center gap-3">
              <button id="submitBtn" class="action-btn text-sm">
                <i class="fas fa-paper-plane text-sm"></i>
                Submit Request
              </button>
              <button id="retakeBtn" class="btn btn-secondary text-sm">
                <i class="fas fa-redo mr-1.5 text-xs"></i>
                Retake
              </button>
            </div>
          </div>
        </div>

        <!-- Loading -->
        <div id="loadingBox" class="hidden text-center py-5 mt-6">
          <div class="inline-flex items-center gap-3 bg-blue-50 px-5 py-3 rounded-xl border border-blue-200">
            <div class="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-sm text-blue-700 font-semibold">Processing your request...</span>
          </div>
        </div>

      </div>
      {% endif %}

    </div>
  </div>

  <script>
    // =====================
    // DOM REFERENCES
    // =====================
    const video = document.getElementById('video');
    const faceCanvas = document.getElementById('faceCanvas');
    const previewImg = document.getElementById('previewImg');
    const captureBtn = document.getElementById('captureBtn');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const submitBtn = document.getElementById('submitBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const enrollBtn = document.getElementById('enrollBtn');
    const updateBtn = document.getElementById('updateBtn');
    const cancelRequestBtn = document.getElementById('cancelRequestBtn');
    const cameraSection = document.getElementById('cameraSection');
    const previewSection = document.getElementById('previewSection');
    const loadingBox = document.getElementById('loadingBox');
    const guidanceText = document.getElementById('guidanceText');
    const cameraControls = document.getElementById('cameraControls');

    // =====================
    // GLOBAL STATE
    // =====================
    let currentStream = null;
    let lastCapturedImage = null;
    let faceDetected = false;
    let detectInterval = null;
    let lastDetectState = null;
    let detectSessionId = 0; // Session guard
    let isProcessing = false; // Cooldown flag
    let requestType = '';

    // üéØ FACE STABILITY & QUALITY GATES
    let stabilityStartTime = null;
    const STABILITY_THRESHOLD_MS = 500; // Reduced from 800ms to 500ms for better UX
    let lastFaceCount = 0;
    let stabilityResetTimeout = null;

    // üéØ STABILITY TIMER FUNCTIONS
    function resetStabilityTimer() {
        stabilityStartTime = null;
        if (stabilityResetTimeout) {
            clearTimeout(stabilityResetTimeout);
            stabilityResetTimeout = null;
        }
    }

    function startStabilityTimer() {
        if (!stabilityStartTime) {
            stabilityStartTime = Date.now();
        }
    }

    // =====================
    // UTILITY FUNCTIONS
    // =====================
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.content;
    }

    function showGuidance(message) {
        if (guidanceText) {
            guidanceText.textContent = message;
            guidanceText.classList.remove("hidden");
        }
    }

    function drawDetectionBox(color = "#ef4444") {
        // Disabled for clean UX - no face detection boxes
        if (!video || !faceCanvas) return;

        const rect = video.getBoundingClientRect();
        faceCanvas.width = rect.width;
        faceCanvas.height = rect.height;

        const ctx = faceCanvas.getContext("2d");
        ctx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);

        // No box drawing - clean interface
    }

    // =====================
    // OLD drawDetectionBox function - DISABLED for clean UX
    /*
    function drawDetectionBox(color = "#ef4444") {
        if (!video || !faceCanvas) return;

        const rect = video.getBoundingClientRect();
        faceCanvas.width = rect.width;
        faceCanvas.height = rect.height;

        const ctx = faceCanvas.getContext("2d");
        ctx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);

        const size = Math.min(rect.width, rect.height) * 0.55;
        const x = (rect.width - size) / 2;
        const y = (rect.height - size) / 2;

        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.shadowColor = color;
        ctx.shadowBlur = 8;

        ctx.strokeRect(x, y, size, size);
    }
    */

    // =====================
    // FACE DETECTION WITH STABILITY & QUALITY GATES
    // =====================
    let isSendingRequest = false; // üö® GUARD AGAINST OVERLAPPING REQUESTS

    async function detectFaceOnce() {
        const sessionAtStart = detectSessionId;
        if (!currentStream || !video.videoWidth || isSendingRequest) {
            guidanceText?.classList.add("hidden");
            captureBtn?.classList.add("hidden");
            return;
        }

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        isSendingRequest = true; // üö® SET GUARD

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
            
            const res = await fetch("/auth/detect_face", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ image: canvas.toDataURL("image/jpeg") }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);

            if (sessionAtStart !== detectSessionId) return;

            const { face_count, distance, lighting } = await res.json();

            let borderColor = "#ef4444";
            let message = "";
            let allowCapture = false;

            // üéØ STEP 1: Basic Face Detection
            if (face_count === 0) {
                // üî¥ STATE-1: No Face
                borderColor = "#ef4444";
                message = "No face detected";
                allowCapture = false;
                resetStabilityTimer(); // Reset stability on no face
            } else if (face_count > 1) {
                // üü† STATE-2: Multiple Faces
                borderColor = "#f97316";
                message = "Multiple faces detected. Only one person allowed";
                allowCapture = false;
                resetStabilityTimer(); // Reset stability on multiple faces
            } else if (face_count === 1) {
                // üéØ STEP 2: Single Face Detected - Now Check Quality Gates

                // Distance Check
                if (distance === "far") {
                    borderColor = "#f59e0b"; // Yellow
                    message = "Move closer to camera";
                    allowCapture = false;
                    resetStabilityTimer();
                } else if (distance === "close") {
                    borderColor = "#f59e0b"; // Yellow
                    message = "Move back from camera";
                    allowCapture = false;
                    resetStabilityTimer();
                }
                // Lighting Check
                else if (lighting === "dark") {
                    borderColor = "#f59e0b"; // Yellow
                    message = "Lighting too dark - find better light";
                    allowCapture = false;
                    resetStabilityTimer();
                } else if (lighting === "bright") {
                    borderColor = "#f59e0b"; // Yellow
                    message = "Lighting too bright - reduce glare";
                    allowCapture = false;
                    resetStabilityTimer();
                }
                // üéØ STEP 3: All Quality Gates Passed - Check Stability
                else {
                    // Start/Continue stability timer
                    if (!stabilityStartTime) {
                        stabilityStartTime = Date.now();
                        message = "Face detected - hold still for quality capture...";
                        borderColor = "#3b82f6"; // Blue - stabilizing
                        allowCapture = false;
                    } else {
                        const stableDuration = Date.now() - stabilityStartTime;

                        if (stableDuration < STABILITY_THRESHOLD_MS) {
                            // Still stabilizing
                            const progress = Math.round((stableDuration / STABILITY_THRESHOLD_MS) * 100);
                            message = `Stabilizing... ${progress}% (hold still)`;
                            borderColor = "#3b82f6"; // Blue - stabilizing
                            allowCapture = false;
                        } else {
                            // üéØ STEP 4: Fully Stable - Ready for Capture
                            message = "Perfect! Click capture";
                            borderColor = "#10b981"; // Green - ready
                            allowCapture = true;
                        }
                    }
                }
            }

            faceDetected = allowCapture;
            drawDetectionBox(borderColor);

            if (guidanceText) {
                guidanceText.textContent = message;
                guidanceText.classList.remove("hidden");
            }

            captureBtn?.classList.add("hidden");
            if (allowCapture) {
                captureBtn?.classList.remove("hidden");
            }

        } catch (err) {
            if (sessionAtStart !== detectSessionId) return;
            captureBtn?.classList.add("hidden");
            guidanceText?.classList.add("hidden");
            console.error("Face detection error:", err);
            resetStabilityTimer();
            
            // üö® STOP LOOP ON FETCH ERRORS (including timeout)
            if (detectInterval && (err.name === 'AbortError' || err.message.includes('fetch'))) {
                clearInterval(detectInterval);
                detectInterval = null;
                console.warn("Face detection loop stopped due to connection errors");
                if (guidanceText) {
                    guidanceText.textContent = "Connection timeout - please refresh page";
                    guidanceText.classList.remove("hidden");
                }
            }
        } finally {
            isSendingRequest = false; // üö® RESET GUARD
        }
    }

    // =====================
    // CAMERA FUNCTIONS
    // =====================
    function startCamera(type) {
        requestType = type;
        detectSessionId++;
        lastDetectState = null;
        faceDetected = false;
        resetStabilityTimer(); // üéØ RESET STABILITY TIMER ON CAMERA START
        isSendingRequest = false; // ‚≠ê ensure detection resumes

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                currentStream = stream;
                video.srcObject = stream;
                cameraSection?.classList.remove("hidden");
                previewSection?.classList.add("hidden");
                loadingBox?.classList.add("hidden");
                faceCanvas?.classList.remove("hidden");
                guidanceText?.classList.remove("hidden");
                cameraControls?.classList.remove("hidden");
                startCameraBtn?.classList.add("hidden");
                stopCameraBtn?.classList.remove("hidden");
                captureBtn?.classList.add("hidden");
                video.onloadeddata = () => drawDetectionBox("#ef4444");
                if (detectInterval) clearInterval(detectInterval);
                detectInterval = setInterval(detectFaceOnce, 800); // ‚è∞ INCREASED INTERVAL

                // ‚≠ê YAHI PE SCROLL KARNA HAI
                requestAnimationFrame(scrollToCamera);
            })
            .catch(err => {
                alert('Camera access denied or not available. Please check permissions.');
                console.error(err);
            });
    }

    function stopCamera() {
        detectSessionId++;
        isProcessing = false; // üö® RESET COOLDOWN
        isSendingRequest = false; // üö® RESET REQUEST GUARD
        resetStabilityTimer(); // üéØ RESET STABILITY TIMER
        if (detectInterval) {
            clearInterval(detectInterval);
            detectInterval = null;
        }
        lastDetectState = null;
        faceDetected = false;
        if (!currentStream) return;

        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
        video.srcObject = null;

        cameraSection?.classList.add("hidden");
        previewSection?.classList.add("hidden");
        loadingBox?.classList.add("hidden");
        faceCanvas?.classList.add("hidden");
        guidanceText?.classList.add("hidden");
        cameraControls?.classList.remove("hidden");
        startCameraBtn?.classList.remove("hidden");
        stopCameraBtn?.classList.add("hidden");
        captureBtn?.classList.add("hidden");
    }

    // =====================
    // EVENT LISTENERS
    // =====================
    // Smoothly bring camera into view when starting enroll/update
    function scrollToCamera() {
        const cam = document.getElementById("cameraSection");
        if (!cam) return;

        // jab tak visible na ho, wait karo
        if (cam.classList.contains("hidden")) {
            requestAnimationFrame(scrollToCamera);
            return;
        }

        const headerOffset = 100; // fixed header height
        const elementPosition = cam.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

        window.scrollTo({
            top: offsetPosition,
            behavior: "smooth"
        });
    }

    enrollBtn?.addEventListener('click', () => {
      startCamera('enroll');
    });
    updateBtn?.addEventListener('click', () => {
      startCamera('update');
    });
    startCameraBtn?.addEventListener('click', () => {
      startCamera(requestType || 'enroll');
    });
    stopCameraBtn?.addEventListener('click', stopCamera);

    captureBtn?.addEventListener('click', () => {
        if (!currentStream || !faceDetected) return;

        if (!requestType) {
            alert("Please choose Enroll or Update first");
            return;
        }

        // üëá FORCE SET (VERY IMPORTANT)
        requestType = requestType || 'enroll';

        // üéØ STEP 1: Lock UI and show "Hold still" message
        detectSessionId++;
        captureBtn.disabled = true;
        captureBtn.innerHTML = '<i class="fas fa-camera mr-2"></i>Hold still...';
        captureBtn.classList.add("opacity-75", "cursor-not-allowed");

        showGuidance("Capturing... Hold still!");

        // üéØ STEP 2: Wait 300ms for autofocus/settling
        setTimeout(() => {
            if (!currentStream) return; // Safety check

            // üéØ STEP 3: Stop detection and prepare capture
            if (detectInterval) {
                clearInterval(detectInterval);
                detectInterval = null;
            }

            faceDetected = false;

            // üéØ STEP 4: Create capture canvas (use video dimensions for quality)
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            lastCapturedImage = canvas.toDataURL("image/jpeg", 0.95); // High quality

            // Stop camera stream
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
                video.srcObject = null;
            }

            // üéØ STEP 5: Update UI for preview
            startCameraBtn?.classList.add("hidden");
            stopCameraBtn?.classList.add("hidden");
            captureBtn?.classList.add("hidden");
            guidanceText?.classList.add("hidden");
            cameraSection?.classList.add("hidden");
            faceCanvas?.classList.add("hidden");

            if (previewImg) previewImg.src = lastCapturedImage;
            previewSection?.classList.remove("hidden");
            cameraControls?.classList.add("hidden");

            // üéØ STEP 6: Reset stability for next capture
            resetStabilityTimer();

            console.log("‚úÖ Face captured successfully with stability gates");

            // üîì ALLOW SAVE PHASE
            isProcessing = false;

        }, 300); // 300ms delay for settling
    });

    retakeBtn?.addEventListener('click', () => {
        // üî• FULL RESET
        isProcessing = false;
        isSendingRequest = false;   // ‚≠ê VERY IMPORTANT
        faceDetected = false;
        lastCapturedImage = null;

        detectSessionId++;          // kill old async loops
        resetStabilityTimer();
        stabilityStartTime = null;

        // üßπ CLEAN UI STATE
        captureBtn.disabled = false;   // ‚≠ê‚≠ê‚≠ê FIX
        captureBtn.innerHTML = '<i class="fas fa-camera mr-2"></i>Capture Face';
        captureBtn.classList.remove("opacity-75", "cursor-not-allowed");
        captureBtn.classList.add("hidden");

        guidanceText.textContent = "Position your face in the frame";
        guidanceText.classList.remove("hidden");

        previewSection.classList.add("hidden");

        // üõë HARD STOP any leftover detection loop
        if (detectInterval) {
            clearInterval(detectInterval);
            detectInterval = null;
        }

        // üéØ Restart camera cleanly
        startCamera(requestType || 'enroll');
    });

    submitBtn?.addEventListener('click', async () => {
        if (!lastCapturedImage) {
            alert("No image captured");
            return;
        }
        if (isProcessing) {
            console.warn("Submit blocked: already processing");
            return;
        }

        console.log({
            isProcessing,
            lastCapturedImage: !!lastCapturedImage,
            requestType
        });

        if (!lastCapturedImage?.startsWith("data:image")) {
            alert("Invalid image captured. Please retake.");
            return;
        }

        if (!requestType) {
            alert('Please select a request type (Enroll or Update) first.');
            return;
        }

        isProcessing = true;
        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

        if (loadingBox) loadingBox.classList.remove("hidden");

        try {
            const res = await fetch('/employee/submit_face_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    request_type: requestType,
                    image: lastCapturedImage
                })
            });

            const data = await res.json();

            if (loadingBox) loadingBox.classList.add("hidden");

            if (data.status === "success") {
                isProcessing = false; // ‚úÖ RESET
                alert(data.message || "Your request has been submitted for admin approval.");
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Request failed'));
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Submit error:', error);
            alert('Network error occurred. Please try again.');
            isProcessing = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            if (loadingBox) loadingBox.classList.add("hidden");
        }
    });

    cancelRequestBtn?.addEventListener('click', async () => {
        showFaceRequestCancelModal();
    });

    // =====================
    // INITIALIZATION
    // =====================
    cameraControls?.classList.remove("hidden");
    startCameraBtn?.classList.remove("hidden");
    stopCameraBtn?.classList.add("hidden");
    captureBtn?.classList.add("hidden");
    previewSection?.classList.add("hidden");
    loadingBox?.classList.add("hidden");
    if (faceCanvas) faceCanvas.classList.add("hidden");
    if (guidanceText) guidanceText.classList.add("hidden");

    // Add scroll reveal animations
    document.addEventListener('DOMContentLoaded', function() {
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.animationDelay = entry.target.style.getPropertyValue('--delay') || '0s';
            entry.target.classList.add('animate-in');
          }
        });
      }, observerOptions);

      document.querySelectorAll('.scroll-reveal').forEach(el => {
        observer.observe(el);
      });
    });
  </script>

<!-- Face Request Cancellation Confirmation Modal -->
<div id="faceRequestCancelModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center" onclick="if(event.target === this) hideFaceRequestCancelModal()">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-times-circle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Cancel Face Request</h3>
        </div>

        <div class="mb-6">
            <p class="text-gray-600">Are you sure you want to cancel your pending face request? This action cannot be undone.</p>
        </div>

        <div class="flex gap-3">
            <button type="button" onclick="confirmFaceRequestCancellation()"
                class="flex-1 bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
                <i class="fas fa-times mr-2"></i>
                Cancel Request
            </button>
            <button type="button" onclick="hideFaceRequestCancelModal()"
                class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                Keep Request
            </button>
        </div>
    </div>
</div>

<script>
function showFaceRequestCancelModal() {
    document.getElementById('faceRequestCancelModal').classList.remove('hidden');
}

function hideFaceRequestCancelModal() {
    document.getElementById('faceRequestCancelModal').classList.add('hidden');
}

async function confirmFaceRequestCancellation() {
    try {
        const res = await fetch('/employee/cancel_face_request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });

        const data = await res.json();

        if (data.status === "success") {
            alert(data.message || "Request cancelled successfully.");
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Cancellation failed'));
        }
    } catch (error) {
        console.error('Cancel error:', error);
        alert('Network error occurred. Please try again.');
    }
    hideFaceRequestCancelModal();
}
</script>

</body>
</html>